# FROM : https://github.com/tsoding/nothing/blob/master/appveyor.yml

image:
  - Ubuntu
  - MacOS
  - Visual Studio 2015

environment: # enable mingw build on windows image
  MSYSTEM: MINGW64
  CHERE_INVOKING: 1
  matrix:
    - BUILD_TYPE: mingw
    - BUILD_TYPE: other

matrix:
  exclude: # no mingw build on unix
    - image: Ubuntu
      BUILD_TYPE: mingw
    - image: MacOS
      BUILD_TYPE: mingw
    - image: Visual Studio 2015
      BUILD_TYPE: other


build_script:
  - ps: |
       if ($isWindows) {
           if ($env:BUILD_TYPE -eq 'mingw') {
              C:\msys64\usr\bin\bash -lc "autoreconf"
              C:\msys64\usr\bin\bash -lc "./configure"
              C:\msys64\usr\bin\bash -lc "make"
              C:\msys64\usr\bin\bash -lc "strip src/iedera.exe"
              C:\msys64\usr\bin\bash -lc "mv -f src/iedera.exe src/iedera-Win64.exe"
           }
       } else {
           bash -c "autoreconf && ./configure && make && strip src/iedera"
           if ($isLinux) {
               bash -c "cp -f src/iedera src/iedera-Linux64.bin"
               bash -c "make check"
               bash <(curl -s https://codecov.io/bash)
           } else {
               bash -c "mv -f src/iedera src/iedera-MacOS64.bin"
           }
       }

artifacts:
  - path: 'src\iedera-*64*'
    name: Releases

deploy:
  provider: GitHub
  description: 'Mac OS X and Windows 64 binaries'
  release: ${APPVEYOR_REPO_TAG_NAME}
  auth_token:
    secure: a+NmYFzXxPCFefjxKpbBxgRjCUJTVBpQkPOyWV3/qXgp5/CB533quFGZh3j+3XOT
  draft: true
  prerelease: true

